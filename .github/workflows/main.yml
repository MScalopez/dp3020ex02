name: Build and Deploy SQL Database Project

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install .NET Framework 4.8 Developer Pack
      - name: Install .NET Framework 4.8 Developer Pack
        run: |
          choco install netfx-4.8-devpack -y

      # Install sqlpackage using Chocolatey as a fallback
      - name: Install sqlpackage
        run: |
          choco install sqlpackage -y

      # Use Azure SQL Action to build and deploy the SQL project
      - name: Build and Deploy SQL Project
        uses: azure/sql-action@v2.3
        with:
          connection-string: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
          path: './dp3020db02.sqlproj'
          action: 'publish'
          build-arguments: '-p:Configuration=Release -p:TargetFrameworkVersion=v4.8'
